<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SR Light, from Bryderi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
    </style>
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="bootstrap/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="bootstrap/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="bootstrap/ico/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="bootstrap/ico/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="bootstrap/ico/apple-touch-icon-57-precomposed.png">
	<link rel="shortcut icon" href="bootstrap/ico/favicon.png">
  </head>

  <body>

	<div class="navbar navbar-inverse navbar-fixed-top">
	      <div class="navbar-inner">
			<div class="container">
				<a class="brand" href="#">SR Light</a>
			</div>
	      </div>
	</div>

	<div id="main" class="container">
	<!-- Main hero unit for a primary marketing message or call to action -->
		<div class="row">
			<div id="categories" class="span4">
				<h2>Kategorier</h2>
				<ul  data-bind="foreach: categories">
					<li><a data-bind="attr: {href: '#/category/'+id}" ><span data-bind="text: name"> </span></a></li>
				</ul>
			</div>
			<div id="programs" class="span4" data-bind="if:programs" >	        
				<span data-bind="with: selectedCategory"><h2 data-bind="text: programcategory.name, with:programs"></h2></span>
				<div data-bind="with: programs">
					<ul data-bind="foreach: programs">
						<li><a data-bind="attr: {href: '#/category/'+$root.selectedCategory().programcategory.id+'/program/'+id }" ><span data-bind="text: name"></span></a></li>
					</ul>
					<ul class="pager" data-bind="if: $root.nextpagePrograms" >  
						<li ><a data-bind="click: $root.morePrograms">Mer</a></li>
					</ul>
				</div>

			</div>
			<div id="episodes" class="span4" data-bind="if: selectedProgram">
				<span data-bind="with: selectedProgram"><h2 data-bind="text: program.name"></h2></span>
				<div data-bind="with:episodes">		
					<ul data-bind="foreach: episodes">
						<li><a data-bind="attr: {href: '#/category/'+$root.selectedCategory().programcategory.id+'/program/'+program.id+'/episode/'+id}"><span data-bind="text: title"></span></a></li>
					</ul>
					<ul class="pager" data-bind="if: $root.nextpageEpisodes">
					  
						<li ><a href="#epsiodes" data-bind="click: $root.moreEpisodes">Mer</a></li>
					</ul>
				</div>
			</div>
		</div>
		<hr/>
		<div id="episode" class="row" data-bind="with: selectedEpisode">
			<div class="span6">
				<h2 data-bind="text: episode.title"></h2></a>
				<span data-bind="text: episode.description"></span></p>
				<span data-bind="if: episode.broadcast">
				<ul data-bind="foreach: episode.broadcast.broadcastfiles" class="unstyled" >
					<li>
						<a data-bind="attr: {href: url}">Lyssna p√• webben</a>
					</li>
				</ul>
				</span>
				<ul class="unstyled">
					<li data-bind="if: episode.listenpodfile">
						<p>
							<a data-bind="attr: {href: episode.downloadpodfile.url}">Ladda ner till senare</a></li>
							<audio controls  data-bind="if: episode.listenpodfile">
								<source data-bind="attr: {src: episode.listenpodfile.url}"> </source>
							</audio><br/>
							
						</p>
					</li>
			      </ul>
				<!-- AddThis Button BEGIN -->
				<div class="addthis_toolbox addthis_default_style ">
					<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
					<a class="addthis_button_tweet"></a>
					<a class="addthis_button_pinterest_pinit"></a>
					<a class="addthis_counter addthis_pill_style"></a>
				</div>
				<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
				<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=matt1as"></script>
				<!-- AddThis Button END -->
			</div>
			<div class="span6">
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
				    var disqus_shortname = 'srmobil'; // required: replace example with your forum shortname

				    /* * * DON'T EDIT BELOW THIS LINE * * */
				    (function() {
					var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
					dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
					(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				    })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
				</div>
			</div>
		</div>
	<hr>
	<footer>
		<p>&copy; Bryderi 2013</p>
	</footer>

	</div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="scripts/sammy-latest.min.js"></script>
	<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
	<script src="bootstrap/js/bootstrap.js"></script>
	  
	<script>
		// Define view model
		function viewModel() {
	    	var self = this;
			self.categories = ko.observableArray();
			self.programs = ko.observableArray();
			self.nextpageEpisodes = ko.observable();
			self.nextpagePrograms = ko.observable();
			self.episodes = ko.observableArray();
			self.selectedEpisode = ko.observable();
			self.selectedCategory = ko.observable();
			self.selectedProgram = ko.observable();
			

			self.init = function() {
				getCategories();
			}
  
			// Update Category
			self.setCategory = function( id ) {
				getCategory(id, self.setCategoryCallback );
				
			}

			self.setCategoryCallback = function( data ) {
				self.selectedCategory( data );
				getPrograms(data.programcategory.id, self.setProgramsCallback );
			}
			
			// Set Categories
			self.setCategories = function( data )  {
				this.categories( data );
			}

			// Set Program
			self.setProgram = function( id ) {
				getProgram( id, self.setProgramCallback);
				
				
			}
			
			self.setProgramCallback = function( data ) {
				self.selectedProgram(data);
				getEpisodes( data.program.id, self.setEpisodesCallback );
			}

			// Set Current Program
			self.setProgramsCallback = function( data ) {
				self.programs( data );
				self.nextpagePrograms( data.pagination.nextpage );
				self.scrollTo("programs");
			}

			// Set Episodes
			self.setEpisodesCallback = function( data ) {
				self.episodes( data );
				self.nextpageEpisodes( data.pagination.nextpage );
				self.scrollTo("episodes");
			}

			// Set Current Episodes
			self.setEpisode = function( id ) {
				
				getEpisode( id, self.setEpisodeCallback );
			}

			// Set Current Episodes
			self.setEpisodeCallback = function( data ) {
				self.selectedEpisode( data );
				self.scrollTo("episode");
			}

			self.previousEpisodes = function() {
				var url = this.previouspage.replace(/callback.*?\&/, "callback=?&");
				$.getJSON(url, function(data) {
					self.episodes(data);	
				});
			}

			self.moreEpisodes = function() {
				if(self.nextpageEpisodes) {
					var url = self.nextpageEpisodes().replace(/callback.*?\&/, "callback=?&");
					$.getJSON(url, function(data) {
						var tmpEpisodes = self.episodes();
						jQuery.each( data.episodes, function( key, value) {
							tmpEpisodes.episodes.push(value);
						}); 
						self.episodes( tmpEpisodes );
						self.nextpageEpisodes(data.pagination.nextpage);

					});
				}
			}

			self.morePrograms = function() {
				if(self.nextpagePrograms()) {
					var url = self.nextpagePrograms().replace(/callback.*?\&/, "callback=?&");
					$.getJSON(url, function(data) {
						var tmpPrograms = self.programs();
						jQuery.each( data.programs, function( key, value) {
							tmpPrograms.programs.push(value);
						}); 
						self.programs( tmpPrograms );
						self.nextpagePrograms(data.pagination.nextpage);
					});
				}
			}

			self.scrollTo = function( anchor ) {
				$('html, body').animate({
					scrollTop: $("#" + anchor ).offset().top	
				}, 1000);
			}

		}
			
		var model = new viewModel();
		ko.applyBindings(model);
		
		function getCategory( id, callback ) {
		     $.getJSON('http://api.sr.se/api/v2/programcategories/' + id + '?format=json&callback=?', function(data) {			
			callback( data );
		     });
		}

		function getPrograms( id, callback ) {
			$.getJSON('http://sverigesradio.se/api/v2/programs?format=json&callback=?&programcategoryid='+id, function(data) {
				callback(data);
			});		
		}
    
		function getProgram( id,callback ) {
			$.getJSON('http://sverigesradio.se/api/v2/programs/'+id+'?format=json&callback=?', function(data) {			
				callback(data);
			});
		}

		function getEpisodes(id, callback) {
			$.getJSON('http://api.sr.se/api/v2/episodes/index?format=json&callback=?&programid=' + id, function(data) {
											
				callback(data);
			});
		}

		function getEpisode( id,callback ) {
			$.getJSON('http://api.sr.se/api/v2/episodes/'+id+'?format=json&callback=?', function(data) {
				callback(data);
			});
			
		}
  

		function getCategories() {
			$.getJSON('http://api.sr.se/api/v2/programcategories/?format=json&callback=?', function(data) {			
				model.categories( data.programcategories );
			});
		}

		
		// Setup view model
		model.init();
		

// define a new Sammy.Application bound to the #main element selector
	Sammy('#main', function() {
        
        // define a 'get' route that will be triggered at '#/path'
        this.get('#/category/:category', function() {
		model.setCategory(this.params['category']);
        });

	this.get('#/category/:category/program/:program', function() {
		if( model.selectedCategory() == undefined|| 
		    model.selectedCategory().programcategory.id != this.params['category'] ) {
			model.setCategory(this.params['category']);
		}
		if( model.selectedProgram() == undefined|| 
		    model.selectedProgram().program.id != this.params['program'] ) {
			model.setProgram(this.params['program']);
		}
        });

	this.get('#/category/:category/program/:program/episode/:episode', function() {
		if( model.selectedCategory()==undefined|| 
		    model.selectedCategory().programcategory.id != this.params['category'] ) {
			model.setCategory(this.params['category']);
		}
		if( model.selectedProgram()==undefined || 
		    model.selectedProgram().program.id != this.params['program'] ) {
			model.setProgram(this.params['program']);
		}
		if( model.selectedEpisode()==undefined || 
		    model.selectedEpisode().episode.id != this.params['episode'] ) {
			model.setEpisode(this.params['episode']);
		}
        });

      }).run();

	
	</script>
  </body>
</html>
